

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>18. Disk Layout:Dealing with Failures &#8212; Introduction to Operating Systems</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'fs/dl_failures';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="19. Disk Layout:Examples of Real World File Systems" href="dl_ex_exx.html" />
    <link rel="prev" title="17. Disk Layout:Implementing Name Space" href="dl_name.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro/pref.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro/pref.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro/intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/purpose.html">2. Purpose of operating systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/structure.html">3. Operating System Structure &amp; Unix/Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/abstractions.html">4. Operating System Abstractions</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/tools.html">5. What you should know</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-shell.html">5.1. Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-editors.html">5.2. Editors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-make.html">5.3. Makefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-git.html">5.4. Git Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-gdb.html">5.5. GDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-c.html">5.6. The C Programming Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/tools-testing.html">5.7. Unit Tests</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Virtual Processor</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../scheduling/intro.html">6. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduling/process.html">7. Virtualizing a CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduling/scheduling.html">8. Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduling/real_sched.html">9. A Look at the Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduling/review.html">10. Review</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">File Systems</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">11. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="interface.html">12. File System Abstraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="diskhw.html">13. A bit about Disks</a></li>
<li class="toctree-l1"><a class="reference internal" href="disklayout.html">14. File System Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="dl_track_used.html">15. Disk Layout:Tracking Used Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="dl_track_free.html">16. Disk Layout:Tracking Free Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="dl_name.html">17. Disk Layout:Implementing Name Space</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">18. Disk Layout:Dealing with Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="dl_ex_exx.html">19. Disk Layout:Examples of Real World File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="kernelimp.html">20. Kernel implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="review.html">21. Review</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Virtual Memory</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../mm/intro.html">22. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/phys-and-seg.html">23. Memory management before paged virtual memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/virt-paging.html">24. Paging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/page-tables.html">25. Page Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/reclamation.html">26. Memory reclaiming algorithms.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/page-size.html">27. Page Sizes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/misc.html">28. Other topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/buffer-cache.html">29. Buffer Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/pagefaults.html">30. Memory Management Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/realworld.html">31. Memory management in the real world</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/concl.html">32. Conclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mm/review.html">33. Review</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Concurrency</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../sync/sync.html">34. Introduction to Concurrency, Synchronization and Deadlock</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/sharing.html">35. Cooperating Processes and Inter-process Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/criticalsection.html">36. The Critical Section Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/locks.html">37. Implementing Locks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/ordering.html">38. Ordering Thread Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/concurrency_bugs.html">39. Common Concurrency Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/readmostly.html">40. Read-Dominated Workloads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/hardware_challenges.html">41. Challenges of Modern Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/linux_locking.html">42. Locking in the Linux Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sync/review.html">43. Review</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Other Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../devices/devices.html">44. Input and Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devices/disk2.html">45. More on Disks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/virt.html">46. Virtualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sec/sec.html">47. Security</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../misc/howto.html">48. How to read this book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/Contributing.html">49. Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/bib.html">50. Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://jupyterhub-opf-jupyterhub.apps.smaug.na.operate-first.cloud/hub/user-redirect/git-pull?repo=https%3A//github.com/OpenOSOrg/openos&urlpath=lab/tree/openos/content/fs/dl_failures.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/OpenOSOrg/openos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OpenOSOrg/openos/edit/main/content/fs/dl_failures.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OpenOSOrg/openos/issues/new?title=Issue%20on%20page%20%2Ffs/dl_failures.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/fs/dl_failures.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Disk Layout:Dealing with Failures</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#consistency-and-journaling">18.1. Consistency and Journaling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#journaling">18.2. Journaling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#log-structured-file-systems">18.3. Log-Structured File Systems</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="disk-layout-dealing-with-failures">
<span id="fs-dl-failures"></span><h1><span class="section-number">18. </span>Disk Layout:Dealing with Failures<a class="headerlink" href="#disk-layout-dealing-with-failures" title="Permalink to this headline">#</a></h1>
<section id="consistency-and-journaling">
<h2><span class="section-number">18.1. </span>Consistency and Journaling<a class="headerlink" href="#consistency-and-journaling" title="Permalink to this headline">#</a></h2>
<p>Unlike in-memory structures, data structures on disk must survive system
crashes, whether due to hardware reasons (e.g., power failure) or
software failures. The problem is compounded by the fact that operating
systems typically cache reads and writes to increase performance, so
that writes to the disk may occur in a much different order than that in
which they were issued by the file system code.</p>
<p>In its simplest form, the problem is that file system operations often
involve writing to multiple disk blocks—for example, moving a file
from one directory to another requires writing to blocks in the source
and destination directories, while creating a file writes to the block
and inode allocation bitmaps, the new inode, the directory block, and
the file data block or blocks<a class="footnote-reference brackets" href="#steps" id="id1">1</a>. If some, but not all, of
these writes occur before a crash, the file system may become
<em>inconsistent</em>—i.e. in a state not achievable through any legal
sequence of file system operations, where some operations may return
improper data or cause data loss.</p>
<figure class="align-right" id="fig-delete-vicious">
<a class="reference internal image-reference" href="../_images/files-corruption.png"><img alt="../_images/files-corruption.png" src="../_images/files-corruption.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.1 </span><span class="caption-text">File, directory, bitmap</span><a class="headerlink" href="#fig-delete-vicious" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>For a particularly vicious example, consider deleting the file <code class="docutils literal notranslate"><span class="pre">/a/b</span></code> as
shown in
<a class="reference internal" href="#fig-delete-vicious"><span class="std std-numref">Fig. 18.1</span></a>, which requires the following actions:</p>
<ol class="arabic simple">
<li><p>Clear the directory entry for /a/b. This is done by marking the entry as
unused and writing its block back to the directory.</p></li>
<li><p>Free the file data block, by clearing the corresponding entry in the
block allocation bitmap</p></li>
</ol>
<figure class="align-right" id="id3">
<a class="reference internal image-reference" href="../_images/files-failure-case1.png"><img alt="../_images/files-failure-case1.png" src="../_images/files-failure-case1.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.2 </span><span class="caption-text">Directory block written before crash</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>This results in two disk blocks being modified and written back to disk;
if the blocks are cached and written back at a later point in time they
may be written to disk in any order. (This doesn’t matter for running
programs, as when they access the file system the OS will check cached
data before going to disk.)</p>
<p>If the system crashes (e.g., due to a power failure) after one of these
blocks has been written to disk, but not the other, two cases are
possible:</p>
<ol class="arabic simple">
<li><p>The directory block is written, but not the bitmap. The file is no
longer accessible, but the block is still marked as in use. This is a
disk space leak (like a memory leak), resulting in a small loss of disk
space but no serious problems.</p></li>
<li><p>The bitmap block is written, but not the directory. Applications are
still able to find the file, open it, and write to it, but the block is
also available to be allocated to a new file or directory. This is much
more serious.</p></li>
</ol>
<p>If the same block is re-allocated for a new file (<code class="docutils literal notranslate"><span class="pre">/a/c</span></code> in this
case), we now have two files sharing the same data block, which is
obviously a problem. If an application writes to <code class="docutils literal notranslate"><span class="pre">/a/b</span></code> it will also
overwrite any data in <code class="docutils literal notranslate"><span class="pre">/a/c</span></code>, and vice versa. If <code class="docutils literal notranslate"><span class="pre">/a/c</span></code> is a directory
rather than a file things are even worse—a write to <code class="docutils literal notranslate"><span class="pre">/a/b</span></code> will wipe
out directory entries, causing files pointed to by those entries to be
lost. (The files themselves won’t be erased, but without directory entries pointing to them there won’t be any way for a
program to access them.)</p>
<figure class="align-right" id="fig-delete-vicious2">
<a class="reference internal image-reference" href="../_images/files-failure-case2.png"><img alt="../_images/files-failure-case2.png" src="../_images/files-failure-case2.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.3 </span><span class="caption-text">Bitmap block written before crash</span><a class="headerlink" href="#fig-delete-vicious2" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>This can be prevented by writing blocks in a specific order—for
instance, in this case the directory entry could always be cleared before
the block is marked as free, as shown in <a class="reference internal" href="#fig-syncwrites"><span class="std std-numref">Fig. 18.4</span></a>, so that in the worst case a crash might
cause a few data blocks to become unusable. Unfortunately, this is very
slow, as these writes must be done synchronously, waiting for each write
to complete before issuing the next one.</p>
<figure class="align-default" id="fig-syncwrites">
<a class="reference internal image-reference" href="../_images/files-syncwrite.png"><img alt="../_images/files-syncwrite.png" src="../_images/files-syncwrite.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.4 </span><span class="caption-text">Synchronous disk writes for ext2 consistency.</span><a class="headerlink" href="#fig-syncwrites" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Fsck / chkdsk</strong>:
An alternative to the overhead of synchronous file system writes is to allow the OS to write blocks back to disk in any order, but detect and recover from any inconsistencies that occur due to an untimely crash. One way to do this is to run a disk checking
routine every time the system boots after a crash. Earlier in <a class="reference internal" href="disklayout.html#cont-fs-layout"><span class="std std-numref">Section 14</span></a> we mentioned the file system superblock contained information to help with recovery. In particular, the superblock contains a <em>dirty</em> flag, which is set to <strong>true</strong> when the file system is mounted, and set to <strong>false</strong> when the file system is cleanly unmounted. In both cases, these changes to the superblock dirty flag are written to disk.  When a
machine boots, or a file system is mounted later, if the file system is marked dirty, <code class="docutils literal notranslate"><span class="pre">fsck</span></code> (or <code class="docutils literal notranslate"><span class="pre">chkdsk</span></code>
in Windows) is run to repair any problems.</p>
<p>In particular, the Unix file system checker performs the following
checks and corrections:</p>
<ol class="arabic simple">
<li><p>Blocks and sizes. Each allocated inode is checked to see that (a) the
number of blocks reachable through direct and indirect pointers is
consistent with the file size in the inode, (b) all block pointers are
within the valid range for the volume, and (c) no blocks are referenced
by more than one inode.</p></li>
<li><p>Pathnames. The directory tree is traversed from the root, and each entry
is checked to make sure that it points to a valid inode of the same type
(directory / file / device) as indicated in the entry.</p></li>
<li><p>Connectivity. Verifies that all directory inodes are reachable from the
root.</p></li>
<li><p>Reference counts. Each inode holds a count of how many directory entries
(hard links) are pointing to it. This step validates that count against
the count determined by traversing the directory tree, and fixes it if
necessary.</p></li>
<li><p>“Cylinder Groups”. The block and inode bitmaps are checked for
consistency. In particular, are all blocks and inodes reachable from the
root marked in use, and all unreachable ones marked free?</p></li>
<li><p>“Salvage Cylinder Groups”. Free inode and block bitmaps are updated to
fix any discrepancies.</p></li>
</ol>
<p>This is a lot of work, and involves a huge number of disk seeks. On a
large volume it can take hours to run. Note that full recovery may
involve a lot of manual work; for instance, if fsck finds any files
without matching directory entries, it puts them into a <code class="docutils literal notranslate"><span class="pre">lost+found</span></code>
directory with numeric names, leaving a human (i.e., you) to figure out
what they are and where they belong.</p>
<p>Checking disks at startup worked fine when disks were small, but as they
got larger (and seek times didn’t get faster) it started taking longer
and longer to check a file system after a crash. Uninterruptible power
supplies help, but not completely, since many crashes are due to
software faults in the operating system. The corruption problem you saw
was due to inconsistency in the on-disk file system state. In this
example, the free space bitmap did not agree with the directory entry
and inode. If the file system can ensure that the on-disk data is always
in a consistent state, then it should be possible to prevent losing any
data except that being written at the exact moment of the crash.</p>
<p>Performing disk operations synchronously (and carefully ordering them in
the code) will prevent inconsistency, but as described above, imposes
excessive performance costs. Instead a newer generation of file systems,
termed <em>journaling</em> file systems, has incorporated mechanisms which add
additional information which can be used for recovery, allowing caching
and efficient use of the disk, while maintaining a consistent on-disk
state.</p>
</section>
<section id="journaling">
<h2><span class="section-number">18.2. </span>Journaling<a class="headerlink" href="#journaling" title="Permalink to this headline">#</a></h2>
<p>Most modern file systems (NTFS, ext3, ext4, and various others) use
<em>journaling</em>, a variant of the database technique of <em>write-ahead
logging</em>. The idea is to keep a log which records the changes that are
going to be made to the file system, <em>before those changes are made</em>.
After an entry is written to the log, the changes can be written back in
any order; after they are all written, the section of log recording
those changes can be freed.</p>
<p>When recovering from a crash, the OS goes through the log and checks
that all the changes recorded there have been performed on the file
system itself<a class="footnote-reference brackets" href="#log" id="id2">2</a>. Some thought should convince you that if a log entry
is written, then the modification is guaranteed to happen, either before
or after a crash; if the log entry isn’t written completely then the
modification never happened. (There are several ways to detect a
half-written log entry, including using an explicit end marker or a
checksum; we’ll just assume that it’s possible.)</p>
<figure class="align-right" id="id4">
<a class="reference internal image-reference" href="../_images/files-logging.png"><img alt="../_images/files-logging.png" src="../_images/files-logging.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.5 </span><span class="caption-text">Step 1: record action in log</span><a class="headerlink" href="#id4" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-right" id="id5">
<a class="reference internal image-reference" href="../_images/files-corruption2.png"><img alt="../_images/files-corruption2.png" src="../_images/files-corruption2.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.6 </span><span class="caption-text">Step 2: write blocks in any order</span><a class="headerlink" href="#id5" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Ext3 Journaling</strong>: The ext3 file system uses physical block logging:
each log entry contains a header identifying the disk blocks which are
modified (in the example you saw earlier, the bitmap and the directory
entry) and a copy of the disk blocks themselves. After a crash the log
is replayed by writing each block from the log to the location where it
belongs. If a block is written multiple times in the log, it will get
overwritten multiple times during replay, and after the last over-write
it will have the correct value.</p>
<p>To avoid synchronous journal writes for every file operation, ext3 uses
<em>batch commit</em>: journal writes are deferred, and multiple writes are
combined into a single transaction. The log entries for the entire batch
are written to the log in a single sequential write, called a
<em>checkpoint</em>. In the event of a crash, any modifications since the last
checkpoint will be lost, but since checkpoints are performed at least
every few seconds, this typically isn’t a problem. (If your program
needs a guarantee that data is written to a file <em>right now</em>, you need
to use the <code class="docutils literal notranslate"><span class="pre">fsync</span></code> system call to flush data to disk.)</p>
<p>Ext3 supports three different journaling modes:</p>
<ul class="simple">
<li><p><em>Journaled</em>: In this mode, all changes (to file data, directories,
inodes and bitmaps) are written to the log before any modifications are
made to the main file system.</p></li>
<li><p><em>Ordered</em>: Here, data blocks are flushed to the main file system before
a journal entry for any metadata changes (directories, free space
bitmaps, inodes) is written to the log, after which the metadata changes
may be made in the file system. This provides the same consistency
guarantees as journaled mode, but is usually faster.</p></li>
<li><p><em>Writeback</em>: In this mode, metadata changes are always written to the
log before being applied to the main file system, but data may be
written at any time. It is faster than the other two modes, and will
prevent the file system itself from becoming corrupted, but data within
a file may be lost.</p></li>
</ul>
</section>
<section id="log-structured-file-systems">
<h2><span class="section-number">18.3. </span>Log-Structured File Systems<a class="headerlink" href="#log-structured-file-systems" title="Permalink to this headline">#</a></h2>
<p>Log-structured file systems (like LFS in NetBSD, or NetApp WAFL) are an
extreme version of a journaled file system: the journal is the entire
file system. Data is never over-written; instead a form of copy-on-write
is used: modified data is written sequentially to new locations in the
log. This gives very high write speeds because all writes (even random
ones) are written sequentially to the disk.</p>
<p><a class="reference internal" href="#fig-fs-lfs"><span class="std std-numref">Fig. 18.7</span></a> compares LFS to ext2, showing a simple file
system with two directories (dir1, dir2) and two files (/dir1/file1,
/dir2/file2). In ext2 the root directory inode is found in a fixed
location, and its data blocks do not move after being allocated; in LFS
both inode and data blocks move around—as they are modified, the new
blocks get written to the head of the log rather than overwriting the
old ones. The result can be seen graphically in the figure—in the LFS
image, pointers only point to the left, pointing to data that is older
than the block holding a pointer.</p>
<figure class="align-default" id="fig-fs-lfs">
<a class="reference internal image-reference" href="../_images/files-lfs.png"><img alt="../_images/files-lfs.png" src="../_images/files-lfs.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.7 </span><span class="caption-text">Ext2 vs. Log-structured file system
layout</span><a class="headerlink" href="#fig-fs-lfs" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Unlike ext2 there is no fixed location to find the root directory; this
is solved by periodically storing its location in a small checkpoint
record in a fixed location in the superblock. (This checkpoint is not
shown in the figure, and would be the only arrow pointing to the right.)</p>
<p>When a data block is re-written, a new block with a new address is used.
This means that the inode (or indirect block) pointing to the data block
must be modified, which means that its address changes.</p>
<p>LFS uses a table mapping inodes to locations on disk, which is updated
with the new inode address to complete the process; this table is itself
stored as a file. (The astute reader may wonder why this update doesn’t
in fact trigger another update to the inode file, leading to an infinite
loop. This is solved by buffering blocks in memory before they are
written, so that multiple changes can be made.)</p>
<figure class="align-right" id="fig-fs-waflbef">
<a class="reference internal image-reference" href="../_images/files-wafl1.png"><img alt="../_images/files-wafl1.png" src="../_images/files-wafl1.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.8 </span><span class="caption-text">WAFL tree before update</span><a class="headerlink" href="#fig-fs-waflbef" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<figure class="align-right" id="fig-fs-waflaft">
<a class="reference internal image-reference" href="../_images/files-wafl2.png"><img alt="../_images/files-wafl2.png" src="../_images/files-wafl2.png" style="width: 200pt;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18.9 </span><span class="caption-text">WAFL tree after update</span><a class="headerlink" href="#fig-fs-waflaft" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>In WAFL these changes percolate all the way up through directory
entries, directory inodes, etc., to the root of the file system,
potentially causing a large number of writes for a small modification.
(although they’ll still be fairly fast since it’s a single sequential
write) To avoid this overhead, WAFL buffers a large number of changes
before writing to disk; thus although any single write will modify the
root directory, only a single modified copy of the root directory has to
be written in each batch.</p>
<p>In <a class="reference internal" href="#fig-fs-waflbef"><span class="std std-numref">Fig. 18.8</span></a> and <a class="reference internal" href="#fig-fs-waflaft"><span class="std std-numref">Fig. 18.9</span></a> a WAFL directory tree is shown before and after
modifying /dir1/file2, with the out-of-date blocks shown in grey. If we
keep a pointer to the old root node, then you can access a copy of the
file system as it was at that point in time. When the disk fills up,
these out-of-date blocks are collected by a garbage collection process,
and made available for new writes.</p>
<p>One of the advantages of a log-structured file system is the ability to
easily keep snapshots of file system state—a pointer to an old version
of the inode table or root directory will give you access to a copy of
the file system at the point in time corresponding to that version.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="steps"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>These steps ignore inode writes to update file or directory
modification times.</p>
</dd>
<dt class="label" id="log"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Actually it doesn’t check, but rather “replays” all the changes
recorded in the log.</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./fs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="dl_name.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">17. </span>Disk Layout:Implementing Name Space</p>
      </div>
    </a>
    <a class="right-next"
       href="dl_ex_exx.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">19. </span>Disk Layout:Examples of Real World File Systems</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#consistency-and-journaling">18.1. Consistency and Journaling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#journaling">18.2. Journaling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#log-structured-file-systems">18.3. Log-Structured File Systems</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By (see contributing chapter book)
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>